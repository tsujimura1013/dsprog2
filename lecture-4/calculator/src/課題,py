import flet as ft
import requests
from datetime import datetime

AREA_URL = "http://www.jma.go.jp/bosai/common/const/area.json"
FORECAST_URL = "https://www.jma.go.jp/bosai/forecast/data/forecast/{}.json"


# å¤©æ°—â†’çµµæ–‡å­—ã®ç°¡æ˜“ãƒãƒƒãƒ—
def weather_icon(text):
    if "é›¨" in text:
        return "ğŸŒ§ï¸"
    if "é›ª" in text:
        return "â„ï¸"
    if "æ›‡" in text:
        return "â›…"
    if "æ™´" in text:
        return "â˜€ï¸"
    return "ğŸŒˆ"


def main(page: ft.Page):
    page.title = "å¤©æ°—äºˆå ±ã‚¢ãƒ—ãƒª"
    page.window_width = 1100
    page.window_height = 750

    # =========
    # APIå–å¾—
    # =========
    area_data = requests.get(AREA_URL).json()

    # åœ°æ–¹ãƒªã‚¹ãƒˆ
    regions = area_data["class10s"]
    prefectures = area_data["offices"]

    # ---- å·¦å´ãƒ‘ãƒãƒ«UI ----
    region_tiles = []
    forecast_cards = ft.Row(wrap=True, spacing=20)

    result_title = ft.Text("åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„", size=18, weight=ft.FontWeight.BOLD)

    # -------------------------
    # äºˆå ±ã‚’æç”»ã™ã‚‹é–¢æ•°
    # -------------------------
    def show_forecast(code, name):

        forecast_cards.controls.clear()

        data = requests.get(FORECAST_URL.format(code)).json()

        # æ—¥ä»˜
        dates = data[0]["timeSeries"][0]["timeDefines"]

        # å¤©æ°—æ–‡
        weathers = data[0]["timeSeries"][0]["areas"][0]["weathers"]

        # æ°—æ¸©
        temps_min = data[1]["timeSeries"][1]["areas"][0]["tempsMin"]
        temps_max = data[1]["timeSeries"][1]["areas"][0]["tempsMax"]

        result_title.value = f"{name} ã®å¤©æ°—äºˆå ±"

        # ===================
        # æ—¥ã”ã¨ã®ã‚«ãƒ¼ãƒ‰ä½œæˆ
        # ===================
        for i in range(len(dates)):

            date_str = datetime.fromisoformat(dates[i]).strftime("%Y-%m-%d")
            weather_text = weathers[i]
            icon = weather_icon(weather_text)

            # æ°—æ¸©ã¯æ¬ æãŒã‚ã‚‹ã®ã§ã‚¬ãƒ¼ãƒ‰
            tmin = temps_min[i] if i < len(temps_min) else "-"
            tmax = temps_max[i] if i < len(temps_max) else "-"

            card = ft.Container(
                width=150,
                height=180,
                padding=10,
                bgcolor=ft.colors.WHITE,
                border_radius=10,
                content=ft.Column(
                    [
                        ft.Text(date_str, weight=ft.FontWeight.BOLD),
                        ft.Text(icon, size=30),
                        ft.Text(weather_text, size=12),
                        ft.Text(f"{tmin}â„ƒ   /   {tmax}â„ƒ",
                                spans=[
                                    ft.TextSpan(f"{tmin}â„ƒ", style=ft.TextStyle(color=ft.colors.BLUE)),
                                    ft.TextSpan(" / "),
                                    ft.TextSpan(f"{tmax}â„ƒ", style=ft.TextStyle(color=ft.colors.RED)),
                                ])
                    ],
                    alignment=ft.MainAxisAlignment.CENTER,
                    horizontal_alignment=ft.CrossAxisAlignment.CENTER,
                ),
            )

            forecast_cards.controls.append(card)

        page.update()

    # --------------------------------
    # å·¦ã®åœ°æ–¹ â†’ çœŒ ExpansionTileç”Ÿæˆ
    # --------------------------------
    for region in regions.values():
        region_name = region["name"]
        region_code_head = region["code"][:2]

        tiles = []

        for code, pref in prefectures.items():
            if code.startswith(region_code_head):
                tiles.append(
                    ft.ListTile(
                        title=ft.Text(pref["name"]),
                        subtitle=ft.Text(code),
                        on_click=lambda e, c=code, n=pref["name"]: show_forecast(c, n),
                    )
                )

        region_tiles.append(
            ft.ExpansionTile(
                title=ft.Text(region_name),
                controls=tiles,
            )
        )

    sidebar = ft.Container(
        width=280,
        bgcolor="#607D8B",
        padding=15,
        content=ft.Column(
            [ft.Text("åœ°åŸŸã‚’é¸æŠ", size=18, color="white")] + region_tiles,
            scroll=ft.ScrollMode.AUTO,
        ),
    )

    # å³å´
    content_area = ft.Container(
        expand=True,
        padding=20,
        bgcolor="#B0BEC5",
        content=ft.Column(
            [
                result_title,
                forecast_cards,
            ],
            scroll=ft.ScrollMode.AUTO,
        ),
    )

    # å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    page.add(
        ft.Column(
            [
                ft.AppBar(title=ft.Text("å¤©æ°—äºˆå ±ã‚¢ãƒ—ãƒª"), bgcolor="#3F51B5", color="white"),
                ft.Row(
                    [
                        sidebar,
                        content_area,
                    ],
                    expand=True,
                ),
            ]
        )
    )


ft.app(target=main)
